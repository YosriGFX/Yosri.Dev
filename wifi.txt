#!/bin/bash


apt-get update -y
apt-get install -y dhcpcd hostapd dnsmasq build-essential git dkms iptables

git clone https://github.com/kelebek333/rtl8188fu
dkms add ./rtl8188fu
dkms build rtl8188fu/1.0
dkms install rtl8188fu/1.0
cp ./rtl8188fu/firmware/rtl8188fufw.bin /lib/firmware/rtlwifi/

mkdir -p /etc/modprobe.d/
touch /etc/modprobe.d/rtl8188fu.conf
echo "options rtl8188fu rtw_power_mgnt=0 rtw_enusbss=0" | tee /etc/modprobe.d/rtl8188fu.conf

echo "Creating /etc/wpa_supplicant/wpa_supplicant-wlan1.conf"
printf 'ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=US
network={
    ssid="Lafayette"
    psk="Hamdilag86"
}' > /etc/wpa_supplicant/wpa_supplicant-wlan1.conf
echo "Creating /etc/dhcpcd.conf"
printf "interface wlan1
    static ip_address=192.168.1.40/24
    static routers=192.168.1.1
interface wlan0
    static ip_address=192.168.220.1/24
    static routers=192.168.220.0" > /etc/dhcpcd.conf
echo "Creating /etc/hostapd/hostapd.conf"
printf "interface=wlan0
hw_mode=g
channel=6
ieee80211n=1
wmm_enabled=1
macaddr_acl=0
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
ssid=Home
wpa_passphrase=Home123456" > /etc/hostapd/hostapd.conf
echo "Creating /etc/default/hostapd"
printf '\nDAEMON_CONF="/etc/hostapd/hostapd.conf"\n\n' > /etc/default/hostapd
mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
echo "Creating /etc/dnsmasq.conf"
printf "interface=wlan0
listen-address=192.168.220.1
server=8.8.8.8
bind-interfaces
dhcp-range=192.168.220.50,192.168.220.150,12h" > /etc/dnsmasq.conf
echo "Creating /etc/sysctl.conf"
printf "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"
iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE  
iptables -A FORWARD -i wlan0 -o wlan1 -m state --state RELATED,ESTABLISHED -j ACCEPT  
iptables -A FORWARD -i wlan1 -o wlan0 -j ACCEPT
sh -c "iptables-save > /etc/iptables.ipv4.nat"
printf "iptables-restore < /etc/iptables.ipv4.nat" >> /etc/rc.local
systemctl unmask hostapd
systemctl enable hostapd
service hostapd start
service dnsmasq start
